syntax = "proto3";

package pomerium.config;

import "google/protobuf/duration.proto";
import "google/protobuf/struct.proto";
import "google/protobuf/timestamp.proto";
import "google/protobuf/wrappers.proto";
import "validate/validate.proto";

option go_package = "github.com/pomerium/pomerium/pkg/grpc/config";

message Config {
  string         name     = 1;
  repeated Route routes   = 2;
  Settings       settings = 3;
}

message VersionedConfig {
  Config config = 1;

  // List of conditions that must hold in order to apply this config.
  repeated Condition conditions = 2;

  message Condition {
    // Feature gate version to check, or unset to check overall version.
    optional string feature = 1;

    // If set: specifies a minimum feature version (inclusive).
    optional string at_least = 2;

    // If set: specifies a maximum feature version (exclusive).
    optional string less_than = 3;
  }
}

message RouteRewriteHeader {
  string header = 1;
  oneof matcher {
    string prefix = 3;
  }
  string value = 2;
}

message RouteRedirect {
  optional bool   https_redirect  = 1;
  optional string scheme_redirect = 2;
  optional string host_redirect   = 3;
  optional uint32 port_redirect   = 4;
  optional string path_redirect   = 5;
  optional string prefix_rewrite  = 6;
  optional int32  response_code   = 7;
  optional bool   strip_query     = 8;
}

message RouteDirectResponse {
  uint32 status = 1;
  string body   = 2;
}

enum IssuerFormat {
  // Issuer strings will be the hostname of the route, with no scheme or
  // trailing slash.
  IssuerHostOnly = 0;
  // Issuer strings will be a complete URI, including the scheme and ending
  // with a trailing slash.
  IssuerURI = 1;
}

enum BearerTokenFormat {
  BEARER_TOKEN_FORMAT_UNKNOWN            = 0;
  BEARER_TOKEN_FORMAT_DEFAULT            = 1;
  BEARER_TOKEN_FORMAT_IDP_ACCESS_TOKEN   = 2;
  BEARER_TOKEN_FORMAT_IDP_IDENTITY_TOKEN = 3;
}

// CircuitBreakerThresholds defines CircuitBreaker settings.
message CircuitBreakerThresholds {
  // The maximum number of connections that Envoy will make to the upstream
  // cluster. If not specified, the default is 1024.
  optional uint32 max_connections = 1;
  // The maximum number of pending requests that Envoy will allow to the
  // upstream cluster. If not specified, the default is 1024. This limit is
  // applied as a connection limit for non-HTTP traffic.
  optional uint32 max_pending_requests = 2;
  // The maximum number of parallel requests that Envoy will make to the
  // upstream cluster. If not specified, the default is 1024. This limit does
  // not apply to non-HTTP traffic.
  optional uint32 max_requests = 3;
  // The maximum number of parallel retries that Envoy will allow to the
  // upstream cluster. If not specified, the default is 3.
  optional uint32 max_retries = 4;
  // The maximum number of connection pools per cluster that Envoy will
  // concurrently support at once. If not specified, the default is unlimited.
  // Set this for clusters which create a large number of connection pools.
  optional uint32 max_connection_pools = 5;
}

// EntityInfo is the basic metadata for an entity.
message EntityInfo {
  optional string id   = 1;
  optional string name = 2;
  optional google.protobuf.Timestamp modified_at = 3;
}

// Next ID: 93.
message Route {
  message StringList {
    repeated string values = 1;
  }

  // The id of the route.
  optional string id = 28;
  // The namespace id of the route.
  optional string namespace_id = 80;
  // The originator id of the route.
  optional string originator_id = 81;
  // The name of the route.
  optional string name = 1;
  // The name used for stats telemetry with the route.
  optional string stat_name = 75;
  // A human-readable description of the route.
  optional string description = 67;
  // A URL for a logo for the route.
  optional string logo_url = 68;

  string              from     = 2;
  repeated string     to       = 3;
  RouteRedirect       redirect = 34;
  RouteDirectResponse response = 62;

  // https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/endpoint/v3/endpoint_components.proto#envoy-v3-api-msg-config-endpoint-v3-lbendpoint
  // optional load balancing weights assigned to upstream servers defined in TO
  // if not specified, all upstream servers would be assigned the same weight
  // if provided, load_balancing_weights[i] >= 1 and len(to) ==
  // len(load_balancing_weights)
  repeated uint32 load_balancing_weights = 37;

  repeated string allowed_users = 4 [deprecated = true];
  reserved 5; // was allowed_groups
  repeated string                        allowed_domains    = 6  [deprecated = true];
  map<string, google.protobuf.ListValue> allowed_idp_claims = 32 [deprecated = true];

  string prefix = 7;
  string path   = 8;
  string regex  = 9;

  string         prefix_rewrite             = 29;
  string         regex_rewrite_pattern      = 30;
  string         regex_rewrite_substitution = 31;
  optional int64 regex_priority_order       = 61;

  bool                     cors_allow_preflight                = 10;
  bool                     allow_public_unauthenticated_access = 11;
  bool                     allow_any_authenticated_user        = 33;
  google.protobuf.Duration timeout                             = 12;
  google.protobuf.Duration idle_timeout                        = 43;
  bool                     allow_websockets                    = 13;
  bool                     allow_spdy                          = 44;

  bool            tls_skip_verify            = 14;
  string          tls_server_name            = 15;
  string          tls_upstream_server_name   = 57;
  string          tls_downstream_server_name = 58;
  string          tls_custom_ca              = 16;
  string          tls_custom_ca_file         = 17;
  optional string tls_custom_ca_key_pair_id  = 82;

  string          tls_client_cert                      = 18;
  string          tls_client_key                       = 19;
  string          tls_client_cert_file                 = 20;
  string          tls_client_key_file                  = 21;
  optional string tls_client_key_pair_id               = 83;
  string          tls_downstream_client_ca             = 38;
  string          tls_downstream_client_ca_file        = 39;
  optional string tls_downstream_client_ca_key_pair_id = 84;

  bool tls_upstream_allow_renegotiation = 60;

  map<string, string>         set_request_headers      = 22;
  repeated string             remove_request_headers   = 23;
  map<string, string>         set_response_headers     = 41;
  repeated RouteRewriteHeader rewrite_response_headers = 40;
  reserved 54; // was set_authorization_header

  bool          preserve_host_header  = 24;
  optional bool pass_identity_headers = 25;

  string                kubernetes_service_account_token              = 26;
  string                kubernetes_service_account_token_file         = 64;
  optional string       kubernetes_service_account_token_key_pair_id  = 85;
  bool                  enable_google_cloud_serverless_authentication = 42;
  optional IssuerFormat jwt_issuer_format                             = 65;
  repeated string       jwt_groups_filter                             = 66;
  // Whether to add JWT groups from any PPL policies.
  // Not supported in the open source version of Pomerium.
  optional bool              jwt_groups_filter_infer_from_ppl = 89;
  optional BearerTokenFormat bearer_token_format              = 70;
  repeated string            depends_on                       = 71;

  reserved 36; // was envoy_opts

  repeated Policy    policies     = 27;
  repeated PPLPolicy ppl_policies = 63;
  repeated string    policy_ids   = 86;

  optional string host_rewrite                         = 50;
  optional string host_rewrite_header                  = 51;
  optional string host_path_regex_rewrite_pattern      = 52;
  optional string host_path_regex_rewrite_substitution = 53;

  optional string     idp_client_id                      = 55;
  optional string     idp_client_secret                  = 56;
  optional StringList idp_access_token_allowed_audiences = 69;
  bool                show_error_details                 = 59;

  optional MCP mcp = 72;
  optional CircuitBreakerThresholds circuit_breaker_thresholds = 73;
  optional UpstreamTunnel           upstream_tunnel            = 74;

  optional OutlierDetection    outlier_detection       = 76;
  repeated HealthCheck         health_checks           = 77;
  optional LoadBalancingPolicy load_balancing_policy   = 78;
  optional int32               healthy_panic_threshold = 79;

  // computed properties

  // When the route was created.
  google.protobuf.Timestamp created_at = 87;
  // When the route was last modified.
  google.protobuf.Timestamp modified_at = 88;
  // Policies that are automatically enforced.
  // Not supported in the open source version of Pomerium.
  repeated EntityInfo enforced_policies = 90;
  // Info about policies assigned to this route.
  // Not supported in the open source version of Pomerium.
  repeated EntityInfo assigned_policies = 91;
  // The name of the namespace for the route.
  optional string namespace_name = 92;
}

message UpstreamTunnel {}

message MCP {
  oneof mode {
    MCPServer server = 1;
    MCPClient client = 2;
  }
}

message MCPServer {
  optional UpstreamOAuth2 upstream_oauth2       = 1;
  optional uint32         max_request_bytes     = 2;
  optional string         path                  = 3;
  optional string         authorization_server_url = 4;
}

message MCPClient {}

message UpstreamOAuth2 {
  string          client_id       = 1;
  string          client_secret   = 2;
  OAuth2Endpoint  oauth2_endpoint = 3;
  repeated string scopes          = 4;
}

message OAuth2Endpoint {
  string auth_url  = 1;
  string token_url = 2;
  // if unset, auto-detect which authentication
  // style the provider wants by trying both ways and caching
  // the successful way for the future.
  optional OAuth2AuthStyle auth_style = 3;
}

enum OAuth2AuthStyle {
  OAUTH2_AUTH_STYLE_UNSPECIFIED = 0;

  // OAUTH2_AUTH_STYLE_IN_PARAMS sends the "client_id" and "client_secret"
  // in the POST body as application/x-www-form-urlencoded parameters.
  OAUTH2_AUTH_STYLE_IN_PARAMS = 1;
  // OAUTH2_AUTH_STYLE_IN_HEADER sends the client_id and client_password
  // using HTTP Basic Authorization. This is an optional style
  // described in the OAuth2 RFC 6749 section 2.3.1.
  OAUTH2_AUTH_STYLE_IN_HEADER = 2;
}

message PPLPolicy {
  bytes raw = 1;
}

// Next ID: 20.
message Policy {
  optional string id            = 1;
  optional string namespace_id  = 11;
  optional string originator_id = 12;
  optional string name          = 2;
  optional string description   = 13;
  // An enforced policy is automatically applied to routes.
  // Not supported in the open source version of Pomerium.
  optional bool   enforced      = 14;
  repeated string allowed_users = 3;
  reserved 4; // was allowed_groups
  repeated string                        allowed_domains    = 5;
  map<string, google.protobuf.ListValue> allowed_idp_claims = 7;
  repeated string                        rego               = 6;
  optional string                        source_ppl         = 10;
  optional string                        explanation        = 8;
  optional string                        remediation        = 9;

  // computed properties

  // When the policy was created.
  google.protobuf.Timestamp created_at = 15;
  // When the policy was last modified.
  google.protobuf.Timestamp modified_at = 16;
  // Routes that are automatically enforced by this policy.
  // Not supported in the open source version of Pomerium.
  repeated EntityInfo enforced_routes = 17;
  // Info about routes with this policy assigned.
  // Not supported in the open source version of Pomerium.
  repeated EntityInfo assigned_routes = 18;
  // The name of the namespace for the policy.
  optional string namespace_name = 19;
}

// Next ID: 177.
message Settings {
  message Certificate {
    bytes  cert_bytes = 3;
    bytes  key_bytes  = 4;
    string id         = 5;
  }
  message DataBrokerClusterNode {
    string          id           = 1;
    string          grpc_address = 2;
    optional string raft_address = 3;
  }
  message DataBrokerClusterNodes {
    repeated DataBrokerClusterNode nodes = 1;
  }
  message StringList {
    repeated string values = 1;
  }

  optional string     id                   = 158;
  optional string     namespace_id         = 159;
  optional string     cluster_id           = 176;
  optional string     originator_id        = 160;
  optional string     name                 = 161;
  optional string     installation_id      = 71;
  optional string     log_level            = 3;
  optional StringList access_log_fields    = 114;
  optional StringList authorize_log_fields = 115;
  optional string     proxy_log_level      = 4;
  optional string     shared_secret        = 5;
  optional string     services             = 6;
  optional string     address              = 7;
  optional bool       insecure_server      = 8;

  // dns options
  optional google.protobuf.Duration dns_failure_refresh_rate = 153;
  optional string                   dns_lookup_family        = 60;
  optional google.protobuf.Duration dns_query_timeout        = 149;
  optional uint32                   dns_query_tries          = 148;
  optional google.protobuf.Duration dns_refresh_rate         = 154;
  optional uint32                   dns_udp_max_queries      = 146;
  optional bool                     dns_use_tcp              = 147;

  repeated Certificate              certificates                      = 9;
  repeated string                   certificate_key_pair_ids          = 162;
  optional string                   http_redirect_addr                = 10;
  optional google.protobuf.Duration timeout_read                      = 11;
  optional google.protobuf.Duration timeout_write                     = 12;
  optional google.protobuf.Duration timeout_idle                      = 13;
  optional string                   authenticate_service_url          = 14;
  optional string                   authenticate_internal_service_url = 82;
  optional string                   signout_redirect_url              = 93;
  reserved 15; // was authenticate_callback_path
  optional string cookie_name   = 16;
  optional string cookie_secret = 17;
  optional string cookie_domain = 18;
  reserved 19; // was cookie_secure
  optional bool                     cookie_http_only                   = 20;
  optional google.protobuf.Duration cookie_expire                      = 21;
  optional string                   cookie_same_site                   = 113;
  optional string                   idp_client_id                      = 22;
  optional string                   idp_client_secret                  = 23;
  optional string                   idp_provider                       = 24;
  optional string                   idp_provider_url                   = 25;
  optional StringList               idp_access_token_allowed_audiences = 137;
  repeated string                   scopes                             = 26;
  reserved 27; // was idp_service_account
  reserved 28; // was idp_refresh_directory_timeout
  reserved 29; // was idp_refresh_directory_interval
  map<string, string> request_params                    = 30;
  repeated string     authorize_service_urls            = 32;
  optional string     authorize_internal_service_url    = 83;
  optional string     override_certificate_name         = 33;
  optional string     certificate_authority             = 34;
  optional string     certificate_authority_key_pair_id = 163;
  optional string     derive_tls                        = 96;
  optional string     signing_key                       = 36;
  map<string, string> set_response_headers              = 69;
  reserved 37; // was jwt_claims_headers
  map<string, string>               jwt_claims_headers                 = 63;
  optional IssuerFormat             jwt_issuer_format                  = 139;
  repeated string                   jwt_groups_filter                  = 119;
  optional bool                     jwt_groups_filter_infer_from_ppl   = 175;
  optional BearerTokenFormat        bearer_token_format                = 138;
  optional google.protobuf.Duration default_upstream_timeout           = 39;
  optional string                   debug_address                      = 156;
  optional string                   metrics_address                    = 40;
  optional string                   metrics_basic_auth                 = 64;
  optional Certificate              metrics_certificate                = 65;
  optional string                   metrics_client_ca                  = 66;
  optional string                   metrics_client_ca_key_pair_id      = 164;
  optional string                   otel_traces_exporter               = 121;
  optional double                   otel_traces_sampler_arg            = 122;
  repeated string                   otel_resource_attributes           = 123;
  optional string                   otel_log_level                     = 124;
  optional int32                    otel_attribute_value_length_limit  = 125;
  optional string                   otel_exporter_otlp_endpoint        = 126;
  optional string                   otel_exporter_otlp_traces_endpoint = 127;
  optional string                   otel_exporter_otlp_protocol        = 128;
  optional string                   otel_exporter_otlp_traces_protocol = 129;
  repeated string                   otel_exporter_otlp_headers         = 130;
  repeated string                   otel_exporter_otlp_traces_headers  = 131;
  optional google.protobuf.Duration otel_exporter_otlp_timeout         = 132;
  optional google.protobuf.Duration otel_exporter_otlp_traces_timeout  = 133;
  optional google.protobuf.Duration otel_bsp_schedule_delay            = 134;
  optional int32                    otel_bsp_max_export_batch_size     = 135;
  reserved 41 to 45, 98; // were legacy tracing fields
  optional string                   grpc_address        = 46;
  optional bool                     grpc_insecure       = 47;
  optional google.protobuf.Duration grpc_client_timeout = 99;
  reserved 100; // was grpc_client_dns_roundrobin
  reserved 50; // was forward_auth_url
  optional string                 databroker_cluster_leader_id         = 152;
  optional string                 databroker_cluster_node_id           = 150;
  optional DataBrokerClusterNodes databroker_cluster_nodes             = 151;
  repeated string                 databroker_service_urls              = 52;
  optional string                 databroker_internal_service_url      = 84;
  optional string                 databroker_raft_bind_address         = 155;
  optional string                 databroker_storage_type              = 101;
  optional string                 databroker_storage_connection_string = 102;
  reserved 106; // was databroker_storage_tls_skip_verify
  optional DownstreamMtlsSettings downstream_mtls = 116;
  reserved 53; // was client_ca
  reserved 74; // was client_crl
  optional string google_cloud_serverless_authentication_service_account = 55;
  optional bool   use_proxy_protocol                                     = 107;
  optional bool   autocert                                               = 56;
  optional string autocert_ca                                            = 76;
  optional string autocert_ca_key_pair_id                                = 165;
  optional string autocert_email                                         = 77;
  optional bool   autocert_use_staging                                   = 57;
  optional string autocert_eab_key_id                                    = 78;
  optional string autocert_eab_mac_key                                   = 79;
  optional bool   autocert_must_staple                                   = 58;
  optional string autocert_dir                                           = 59;
  optional string autocert_trusted_ca                                    = 80;
  optional string autocert_trusted_ca_key_pair_id                        = 166;
  optional bool   skip_xff_append                                        = 61;
  optional uint32 xff_num_trusted_hops                                   = 70;
  optional string envoy_admin_access_log_path                            = 108;
  optional string envoy_admin_profile_path                               = 109;
  optional string envoy_admin_address                                    = 110;
  optional string envoy_bind_config_source_address                       = 111;
  optional bool   envoy_bind_config_freebind                             = 112;
  repeated string programmatic_redirect_domain_whitelist                 = 68;

  optional CodecType codec_type = 73;

  reserved 72; // was audit_key
  optional string                   primary_color                 = 85;
  optional string                   secondary_color               = 86;
  optional string                   darkmode_primary_color        = 87;
  optional string                   darkmode_secondary_color      = 88;
  optional string                   logo_url                      = 89;
  optional string                   favicon_url                   = 90;
  optional string                   error_message_first_paragraph = 91;
  optional bool                     pass_identity_headers         = 117;
  map<string, bool>                 runtime_flags                 = 118;
  optional uint32                   http3_advertise_port          = 136;
  optional CircuitBreakerThresholds circuit_breaker_thresholds    = 140;
  optional string                   ssh_address                   = 141;
  optional StringList               ssh_host_key_files            = 142;
  optional StringList               ssh_host_keys                 = 143;
  repeated string                   ssh_host_key_pair_ids         = 167;
  optional string                   ssh_user_ca_key_file          = 144;
  optional string                   ssh_user_ca_key               = 145;
  optional string                   ssh_user_ca_key_pair_id       = 168;
  // mcp_allowed_client_id_domains specifies the allowed domains for MCP client ID metadata URLs.
  // Supports wildcard patterns like "*.example.com".
  // This is REQUIRED when MCP is enabled - client metadata fetching will fail if empty.
  repeated string                   mcp_allowed_client_id_domains       = 157;
  optional string                   directory_provider                  = 171;
  optional google.protobuf.Struct   directory_provider_options          = 172;
  optional google.protobuf.Duration directory_provider_refresh_interval = 173;
  optional google.protobuf.Duration directory_provider_refresh_timeout  = 174;

  // computed properties

  // When the settings were created.
  google.protobuf.Timestamp created_at = 169;
  // When the settings were last modified.
  google.protobuf.Timestamp modified_at = 170;
}

message DownstreamMtlsSettings {
  optional string              ca                      = 1;
  optional string              crl                     = 2;
  optional MtlsEnforcementMode enforcement             = 3;
  repeated SANMatcher          match_subject_alt_names = 4;
  optional uint32              max_verify_depth        = 5;
  optional string              ca_key_pair_id          = 6;
}

enum MtlsEnforcementMode {
  UNKNOWN                  = 0;
  POLICY                   = 1;
  POLICY_WITH_DEFAULT_DENY = 2;
  REJECT_CONNECTION        = 3;
}

message SANMatcher {
  enum SANType {
    SAN_TYPE_UNSPECIFIED = 0;
    EMAIL                = 1;
    DNS                  = 2;
    URI                  = 3;
    IP_ADDRESS           = 4;
    USER_PRINCIPAL_NAME  = 5;
  }
  SANType san_type = 1;
  string  pattern  = 2;
}

enum KeyPairOrigin {
  KEY_PAIR_ORIGIN_UNKNOWN = 0;
  KEY_PAIR_ORIGIN_USER    = 1;
  KEY_PAIR_ORIGIN_SYSTEM  = 2;
}

enum KeyPairStatus {
  KEY_PAIR_STATUS_UNKNOWN = 0;
  KEY_PAIR_STATUS_READY   = 1;
  KEY_PAIR_STATUS_PENDING = 2;
}

// A KeyPair represents a public / private key pair.
message KeyPair {
  // ID of the key pair.
  optional string id = 1 [
    (validate.rules).string.min_len = 1
  ];
  // Namespace of the key pair.
  optional string namespace_id = 2 [
    (validate.rules).string.min_len = 1
  ];
  // Originator of the key pair.
  optional string originator_id = 3 [
    (validate.rules).string.min_len = 1
  ];
  // The name of the key pair.
  optional string name = 4 [
    (validate.rules).string.min_len = 1
  ];
  // The key pair certificate raw bytes.
  optional bytes certificate = 5 [
    (validate.rules).bytes.min_len = 1
  ];
  // THe key pair private key raw bytes.
  optional bytes key = 6 [
    (validate.rules).bytes.min_len = 1
  ];

  // computed properties

  // When the key pair was created.
  google.protobuf.Timestamp created_at = 7;
  // When the key pair was last modified.
  google.protobuf.Timestamp modified_at = 8;
  // The status of the key pair.
  KeyPairStatus status = 9;
  // The origin of the key pair.
  KeyPairOrigin origin = 10;
  // Info about any certificates the key pair has.
  repeated CertificateInfo certificate_info = 11;
}

// KeyUsage specifies the usage flags set on a signed TLS certificate.
message KeyUsage {
  bool digital_signature  = 1;
  bool content_commitment = 2;
  bool key_encipherment   = 3;
  bool data_encipherment  = 4;
  bool key_agreement      = 5;
  bool cert_sign          = 6;
  bool crl_sign           = 7;
  bool encipher_only      = 8;
  bool decipher_only      = 9;
  bool server_auth        = 10;
  bool client_auth        = 11;
}

// Name defines the x509 identity
message Name {
  repeated string country             = 1;
  repeated string organization        = 2;
  repeated string organizational_unit = 3;
  repeated string locality            = 4;
  repeated string province            = 5;
  repeated string street_address      = 6;
  repeated string postal_code         = 7;
  string          serial_number       = 8;
  string          common_name         = 9;
}

// CertificateInfo is a .proto reflection of
// https://golang.org/pkg/crypto/x509/#Certificate
message CertificateInfo {
  int64  version = 1;
  string serial  = 2;

  Name issuer  = 3;
  Name subject = 4;

  google.protobuf.Timestamp not_before = 5;
  google.protobuf.Timestamp not_after  = 6;

  KeyUsage key_usage = 7;

  repeated string dns_names       = 10;
  repeated string email_addresses = 11;
  repeated string ip_addresses    = 12;
  repeated string uris            = 13;

  bool            permitted_dns_domains_critical = 14;
  repeated string permitted_dns_domains          = 15;
  repeated string excluded_dns_domains           = 16;
  repeated string permitted_ip_ranges            = 17;
  repeated string excluded_ip_ranges             = 18;
  repeated string permitted_email_addresses      = 19;
  repeated string excluded_email_addresses       = 20;
  repeated string permitted_uri_domains          = 21;
  repeated string excluded_uri_domains           = 22;
}

// A ServiceAccount represents a Pomerium service account.
message ServiceAccount {
  // ID of the service account.
  optional string id = 1 [
    (validate.rules).string.min_len = 1
  ];
  // Namespace of the service account.
  optional string namespace_id = 2 [
    (validate.rules).string.min_len = 1
  ];
  // Originator of the service account.
  optional string originator_id = 3 [
    (validate.rules).string.min_len = 1
  ];
  // Description of the service account.
  optional string description = 4 [
    (validate.rules).string.min_len = 1
  ];
  // User ID of the service account.
  optional string user_id = 5 [
    (validate.rules).string.min_len = 1
  ];
  // When the service account expires.
  optional google.protobuf.Timestamp expires_at = 6;

  // computed properties

  // When the service account was created.
  google.protobuf.Timestamp created_at = 7;
  // When the service account was last modified.
  google.protobuf.Timestamp modified_at = 8;
  // When the service account was last accessed.
  google.protobuf.Timestamp accessed_at = 9;
}

message CreateKeyPairRequest {
  KeyPair key_pair = 1;
}

message CreateKeyPairResponse {
  KeyPair key_pair = 1;
}

message CreatePolicyRequest {
  Policy policy = 1;
}

message CreatePolicyResponse {
  Policy policy = 1;
}

message CreateRouteRequest {
  Route route = 1;
}

message CreateRouteResponse {
  Route route = 1;
}

message CreateServiceAccountRequest {
  ServiceAccount service_account = 1;
}

message CreateServiceAccountResponse {
  ServiceAccount service_account = 1;
  string         jwt             = 2;
}

message DeleteKeyPairRequest {
  string id = 1;
}

message DeleteKeyPairResponse {}

message DeletePolicyRequest {
  string id = 1;
}

message DeletePolicyResponse {}

message DeleteRouteRequest {
  string id = 1;
}

message DeleteRouteResponse {}

message DeleteServiceAccountRequest {
  string id = 1;
}

message DeleteServiceAccountResponse {}

message GetKeyPairRequest {
  string id = 1;
}

message GetKeyPairResponse {
  KeyPair key_pair = 1;
}

message GetPolicyRequest {
  string id = 1;
}

message GetPolicyResponse {
  Policy policy = 1;
}

message GetRouteRequest {
  string id = 1;
}

message GetRouteResponse {
  Route route = 1;
}

message GetServiceAccountRequest {
  string id = 1;
}

message GetServiceAccountResponse {
  ServiceAccount service_account = 2;
}

message GetSettingsRequest {
  oneof for {
    string id         = 1;
    string cluster_id = 2;
  }
}

message GetSettingsResponse {
  Settings settings = 1;
}

message ListKeyPairsRequest {
  optional uint64                 offset   = 1;
  optional uint64                 limit    = 2;
  optional google.protobuf.Struct filter   = 3;
  optional string                 order_by = 4;
}

message ListKeyPairsResponse {
  repeated KeyPair key_pairs   = 1;
  uint64           total_count = 2;
}

message ListPoliciesRequest {
  optional uint64                 offset   = 1;
  optional uint64                 limit    = 2;
  optional google.protobuf.Struct filter   = 3;
  optional string                 order_by = 4;
}

message ListPoliciesResponse {
  repeated Policy policies    = 1;
  uint64          total_count = 2;
}

message ListRoutesRequest {
  optional uint64                 offset   = 1;
  optional uint64                 limit    = 2;
  optional google.protobuf.Struct filter   = 3;
  optional string                 order_by = 4;
}

message ListRoutesResponse {
  repeated Route routes      = 1;
  uint64         total_count = 2;
}

message ListServiceAccountsRequest {
  optional uint64                 offset   = 1;
  optional uint64                 limit    = 2;
  optional google.protobuf.Struct filter   = 3;
  optional string                 order_by = 4;
}

message ListServiceAccountsResponse {
  repeated ServiceAccount service_accounts = 1;
  uint64                  total_count      = 2;
}

message ListSettingsRequest {
  optional uint64                 offset   = 1;
  optional uint64                 limit    = 2;
  optional google.protobuf.Struct filter   = 3;
  optional string                 order_by = 4;
}

message ListSettingsResponse {
  repeated Settings settings    = 1;
  uint64            total_count = 2;
}

enum ServerType {
  SERVER_TYPE_UNKNOWN    = 0;
  SERVER_TYPE_CORE       = 1;
  SERVER_TYPE_ENTERPRISE = 2;
  SERVER_TYPE_ZERO       = 3;
}

message GetServerInfoRequest {}

message GetServerInfoResponse {
  ServerType server_type = 1;
  string     version     = 2;
}

message UpdateKeyPairRequest {
  KeyPair key_pair = 1;
}

message UpdateKeyPairResponse {
  KeyPair key_pair = 1;
}

message UpdatePolicyRequest {
  Policy policy = 1;
}

message UpdatePolicyResponse {
  Policy policy = 1;
}

message UpdateRouteRequest {
  Route route = 1;
}

message UpdateRouteResponse {
  Route route = 1;
}

message UpdateServiceAccountRequest {
  ServiceAccount service_account = 1;
}

message UpdateServiceAccountResponse {
  ServiceAccount service_account = 1;
}

message UpdateSettingsRequest {
  Settings settings = 1;
}

message UpdateSettingsResponse {
  Settings settings = 1;
}

service ConfigService {
  rpc CreateKeyPair(CreateKeyPairRequest) returns (CreateKeyPairResponse);
  rpc CreatePolicy(CreatePolicyRequest) returns (CreatePolicyResponse);
  rpc CreateRoute(CreateRouteRequest) returns (CreateRouteResponse);
  rpc CreateServiceAccount(CreateServiceAccountRequest) returns (CreateServiceAccountResponse);

  rpc DeleteKeyPair(DeleteKeyPairRequest) returns (DeleteKeyPairResponse);
  rpc DeletePolicy(DeletePolicyRequest) returns (DeletePolicyResponse);
  rpc DeleteRoute(DeleteRouteRequest) returns (DeleteRouteResponse);
  rpc DeleteServiceAccount(DeleteServiceAccountRequest) returns (DeleteServiceAccountResponse);

  rpc GetKeyPair(GetKeyPairRequest) returns (GetKeyPairResponse) {
    option idempotency_level = NO_SIDE_EFFECTS;
  }
  rpc GetPolicy(GetPolicyRequest) returns (GetPolicyResponse) {
    option idempotency_level = NO_SIDE_EFFECTS;
  }
  rpc GetRoute(GetRouteRequest) returns (GetRouteResponse) {
    option idempotency_level = NO_SIDE_EFFECTS;
  }
  rpc GetServerInfo(GetServerInfoRequest) returns (GetServerInfoResponse) {
    option idempotency_level = NO_SIDE_EFFECTS;
  }
  rpc GetServiceAccount(GetServiceAccountRequest) returns (GetServiceAccountResponse) {
    option idempotency_level = NO_SIDE_EFFECTS;
  }
  rpc GetSettings(GetSettingsRequest) returns (GetSettingsResponse) {
    option idempotency_level = NO_SIDE_EFFECTS;
  }

  rpc ListKeyPairs(ListKeyPairsRequest) returns (ListKeyPairsResponse) {
    option idempotency_level = NO_SIDE_EFFECTS;
  }
  rpc ListPolicies(ListPoliciesRequest) returns (ListPoliciesResponse) {
    option idempotency_level = NO_SIDE_EFFECTS;
  }
  rpc ListRoutes(ListRoutesRequest) returns (ListRoutesResponse) {
    option idempotency_level = NO_SIDE_EFFECTS;
  }
  rpc ListServiceAccounts(ListServiceAccountsRequest) returns (ListServiceAccountsResponse) {
    option idempotency_level = NO_SIDE_EFFECTS;
  }
  rpc ListSettings(ListSettingsRequest) returns (ListSettingsResponse) {
    option idempotency_level = NO_SIDE_EFFECTS;
  }

  rpc UpdateKeyPair(UpdateKeyPairRequest) returns (UpdateKeyPairResponse);
  rpc UpdatePolicy(UpdatePolicyRequest) returns (UpdatePolicyResponse);
  rpc UpdateRoute(UpdateRouteRequest) returns (UpdateRouteResponse);
  rpc UpdateServiceAccount(UpdateServiceAccountRequest) returns (UpdateServiceAccountResponse);
  rpc UpdateSettings(UpdateSettingsRequest) returns (UpdateSettingsResponse);
}

// Definitions are taken from envoy with some modifications.
//
// NOTICE:
//
// Envoy
// Copyright The Envoy Project Authors

// Licensed under Apache License 2.0.  See LICENSE for terms.
//
// LICENSE:
//
//                                Apache License
//                          Version 2.0, January 2004
//                       http://www.apache.org/licenses/

//  TERMS AND CONDITIONS FOR USE, REPRODUCTION, AND DISTRIBUTION

//  1. Definitions.

//     "License" shall mean the terms and conditions for use, reproduction,
//     and distribution as defined by Sections 1 through 9 of this document.

//     "Licensor" shall mean the copyright owner or entity authorized by
//     the copyright owner that is granting the License.

//     "Legal Entity" shall mean the union of the acting entity and all
//     other entities that control, are controlled by, or are under common
//     control with that entity. For the purposes of this definition,
//     "control" means (i) the power, direct or indirect, to cause the
//     direction or management of such entity, whether by contract or
//     otherwise, or (ii) ownership of fifty percent (50%) or more of the
//     outstanding shares, or (iii) beneficial ownership of such entity.

//     "You" (or "Your") shall mean an individual or Legal Entity
//     exercising permissions granted by this License.

//     "Source" form shall mean the preferred form for making modifications,
//     including but not limited to software source code, documentation
//     source, and configuration files.

//     "Object" form shall mean any form resulting from mechanical
//     transformation or translation of a Source form, including but
//     not limited to compiled object code, generated documentation,
//     and conversions to other media types.

//     "Work" shall mean the work of authorship, whether in Source or
//     Object form, made available under the License, as indicated by a
//     copyright notice that is included in or attached to the work
//     (an example is provided in the Appendix below).

//     "Derivative Works" shall mean any work, whether in Source or Object
//     form, that is based on (or derived from) the Work and for which the
//     editorial revisions, annotations, elaborations, or other modifications
//     represent, as a whole, an original work of authorship. For the purposes
//     of this License, Derivative Works shall not include works that remain
//     separable from, or merely link (or bind by name) to the interfaces of,
//     the Work and Derivative Works thereof.

//     "Contribution" shall mean any work of authorship, including
//     the original version of the Work and any modifications or additions
//     to that Work or Derivative Works thereof, that is intentionally
//     submitted to Licensor for inclusion in the Work by the copyright owner
//     or by an individual or Legal Entity authorized to submit on behalf of
//     the copyright owner. For the purposes of this definition, "submitted"
//     means any form of electronic, verbal, or written communication sent
//     to the Licensor or its representatives, including but not limited to
//     communication on electronic mailing lists, source code control systems,
//     and issue tracking systems that are managed by, or on behalf of, the
//     Licensor for the purpose of discussing and improving the Work, but
//     excluding communication that is conspicuously marked or otherwise
//     designated in writing by the copyright owner as "Not a Contribution."

//     "Contributor" shall mean Licensor and any individual or Legal Entity
//     on behalf of whom a Contribution has been received by Licensor and
//     subsequently incorporated within the Work.

//  2. Grant of Copyright License. Subject to the terms and conditions of
//     this License, each Contributor hereby grants to You a perpetual,
//     worldwide, non-exclusive, no-charge, royalty-free, irrevocable
//     copyright license to reproduce, prepare Derivative Works of,
//     publicly display, publicly perform, sublicense, and distribute the
//     Work and such Derivative Works in Source or Object form.

//  3. Grant of Patent License. Subject to the terms and conditions of
//     this License, each Contributor hereby grants to You a perpetual,
//     worldwide, non-exclusive, no-charge, royalty-free, irrevocable
//     (except as stated in this section) patent license to make, have made,
//     use, offer to sell, sell, import, and otherwise transfer the Work,
//     where such license applies only to those patent claims licensable
//     by such Contributor that are necessarily infringed by their
//     Contribution(s) alone or by combination of their Contribution(s)
//     with the Work to which such Contribution(s) was submitted. If You
//     institute patent litigation against any entity (including a
//     cross-claim or counterclaim in a lawsuit) alleging that the Work
//     or a Contribution incorporated within the Work constitutes direct
//     or contributory patent infringement, then any patent licenses
//     granted to You under this License for that Work shall terminate
//     as of the date such litigation is filed.

//  4. Redistribution. You may reproduce and distribute copies of the
//     Work or Derivative Works thereof in any medium, with or without
//     modifications, and in Source or Object form, provided that You
//     meet the following conditions:

//     (a) You must give any other recipients of the Work or
//         Derivative Works a copy of this License; and

//     (b) You must cause any modified files to carry prominent notices
//         stating that You changed the files; and

//     (c) You must retain, in the Source form of any Derivative Works
//         that You distribute, all copyright, patent, trademark, and
//         attribution notices from the Source form of the Work,
//         excluding those notices that do not pertain to any part of
//         the Derivative Works; and

//     (d) If the Work includes a "NOTICE" text file as part of its
//         distribution, then any Derivative Works that You distribute must
//         include a readable copy of the attribution notices contained
//         within such NOTICE file, excluding those notices that do not
//         pertain to any part of the Derivative Works, in at least one
//         of the following places: within a NOTICE text file distributed
//         as part of the Derivative Works; within the Source form or
//         documentation, if provided along with the Derivative Works; or,
//         within a display generated by the Derivative Works, if and
//         wherever such third-party notices normally appear. The contents
//         of the NOTICE file are for informational purposes only and
//         do not modify the License. You may add Your own attribution
//         notices within Derivative Works that You distribute, alongside
//         or as an addendum to the NOTICE text from the Work, provided
//         that such additional attribution notices cannot be construed
//         as modifying the License.

//     You may add Your own copyright statement to Your modifications and
//     may provide additional or different license terms and conditions
//     for use, reproduction, or distribution of Your modifications, or
//     for any such Derivative Works as a whole, provided Your use,
//     reproduction, and distribution of the Work otherwise complies with
//     the conditions stated in this License.

//  5. Submission of Contributions. Unless You explicitly state otherwise,
//     any Contribution intentionally submitted for inclusion in the Work
//     by You to the Licensor shall be under the terms and conditions of
//     this License, without any additional terms or conditions.
//     Notwithstanding the above, nothing herein shall supersede or modify
//     the terms of any separate license agreement you may have executed
//     with Licensor regarding such Contributions.

//  6. Trademarks. This License does not grant permission to use the trade
//     names, trademarks, service marks, or product names of the Licensor,
//     except as required for reasonable and customary use in describing the
//     origin of the Work and reproducing the content of the NOTICE file.

//  7. Disclaimer of Warranty. Unless required by applicable law or
//     agreed to in writing, Licensor provides the Work (and each
//     Contributor provides its Contributions) on an "AS IS" BASIS,
//     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or
//     implied, including, without limitation, any warranties or conditions
//     of TITLE, NON-INFRINGEMENT, MERCHANTABILITY, or FITNESS FOR A
//     PARTICULAR PURPOSE. You are solely responsible for determining the
//     appropriateness of using or redistributing the Work and assume any
//     risks associated with Your exercise of permissions under this License.

//  8. Limitation of Liability. In no event and under no legal theory,
//     whether in tort (including negligence), contract, or otherwise,
//     unless required by applicable law (such as deliberate and grossly
//     negligent acts) or agreed to in writing, shall any Contributor be
//     liable to You for damages, including any direct, indirect, special,
//     incidental, or consequential damages of any character arising as a
//     result of this License or out of the use or inability to use the
//     Work (including but not limited to damages for loss of goodwill,
//     work stoppage, computer failure or malfunction, or any and all
//     other commercial damages or losses), even if such Contributor
//     has been advised of the possibility of such damages.

//  9. Accepting Warranty or Additional Liability. While redistributing
//     the Work or Derivative Works thereof, You may choose to offer,
//     and charge a fee for, acceptance of support, warranty, indemnity,
//     or other liability obligations and/or rights consistent with this
//     License. However, in accepting such obligations, You may act only
//     on Your own behalf and on Your sole responsibility, not on behalf
//     of any other Contributor, and only if You agree to indemnify,
//     defend, and hold each Contributor harmless for any liability
//     incurred by, or claims asserted against, such Contributor by reason
//     of your accepting any such warranty or additional liability.

//  END OF TERMS AND CONDITIONS

//  APPENDIX: How to apply the Apache License to your work.

//     To apply the Apache License to your work, attach the following
//     boilerplate notice, with the fields enclosed by brackets "[]"
//     replaced with your own identifying information. (Don't include
//     the brackets!)  The text should be enclosed in the appropriate
//     comment syntax for the file format. We also recommend that a
//     file or class name and description of purpose be included on the
//     same "printed page" as the copyright notice for easier
//     identification within third-party archives.

//  Copyright [yyyy] [name of copyright owner]

//  Licensed under the Apache License, Version 2.0 (the "License");
//  you may not use this file except in compliance with the License.
//  You may obtain a copy of the License at

//      http://www.apache.org/licenses/LICENSE-2.0

//  Unless required by applicable law or agreed to in writing, software
//  distributed under the License is distributed on an "AS IS" BASIS,
//  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
//  See the License for the specific language governing permissions and
//  limitations under the License.
//

// CodecType defines the codec type to use for connections.
enum CodecType {
  CODEC_TYPE_AUTO  = 0;
  CODEC_TYPE_HTTP1 = 1;
  CODEC_TYPE_HTTP2 = 2;
  CODEC_TYPE_HTTP3 = 3;
}

// LoadBalancingPolicy defines the strategy used to balance requests across
// upstream endpoints
enum LoadBalancingPolicy {
  // Default load balancing if not specified
  LOAD_BALANCING_POLICY_UNSPECIFIED = 0;
  // Classic round robin algorithm
  LOAD_BALANCING_POLICY_ROUND_ROBIN = 1;
  // Consistent hashing load balancing
  LOAD_BALANCING_POLICY_MAGLEV = 2;
  // Random selection of backend
  LOAD_BALANCING_POLICY_RANDOM = 3;
  // Consistent hashing on an attribute
  LOAD_BALANCING_POLICY_RING_HASH = 4;
  // Select backend with fewest active requests
  LOAD_BALANCING_POLICY_LEAST_REQUEST = 5;
}

// [#next-free-field: 27]
message HealthCheck {
  // Endpoint health status.
  enum HealthStatus {
    // The health status is not known. This is interpreted by Envoy as ``HEALTHY``.
    UNKNOWN = 0;

    // Healthy.
    HEALTHY = 1;

    // Unhealthy.
    UNHEALTHY = 2;

    // Connection draining in progress. E.g.,
    // `<https://aws.amazon.com/blogs/aws/elb-connection-draining-remove-instances-from-service-with-care/>`_
    // or
    // `<https://cloud.google.com/compute/docs/load-balancing/enabling-connection-draining>`_.
    // This is interpreted by Envoy as ``UNHEALTHY``.
    DRAINING = 3;

    // Health check timed out. This is part of HDS and is interpreted by Envoy as
    // ``UNHEALTHY``.
    TIMEOUT = 4;

    // Degraded.
    DEGRADED = 5;
  }

  message HealthStatusSet {
    // An order-independent set of health status.
    repeated HealthStatus statuses = 1;
  }

  message Int64Range {
    // start of the range (inclusive)
    int64 start = 1;

    // end of the range (exclusive)
    int64 end = 2;
  }

  enum CodecClientType {
    HTTP1 = 0;
    HTTP2 = 1;
    HTTP3 = 2;
  }

  // Describes the encoding of the payload bytes in the payload.
  message Payload {
    oneof payload {
      // Hex encoded payload. E.g., "000000FF".
      string text = 1;

      // Binary payload.
      bytes binary = 2;
    }
  }

  // [#next-free-field: 15]
  message HttpHealthCheck {
    reserved 5, 7;

    reserved "service_name", "use_http2";

    // The value of the host header in the HTTP health check request. If
    // left empty (default value), the name of the cluster this health check is associated
    // with will be used. The host header can be customized for a specific endpoint by setting the
    // :ref:`hostname <envoy_v3_api_field_config.endpoint.v3.Endpoint.HealthCheckConfig.hostname>` field.
    string host = 1;

    // Specifies the HTTP path that will be requested during health checking. For example
    // ``/healthcheck``.
    string path = 2;

    // HTTP specific payload to be sent as the request body during health checking.
    // If specified, the method should support a request body (POST, PUT, PATCH, etc.).
    Payload send = 3;

    // Specifies a list of HTTP expected responses to match in the first ``response_buffer_size`` bytes of the response body.
    // If it is set, both the expected response check and status code determine the health check.
    // When checking the response, “fuzzy” matching is performed such that each payload block must be found,
    // and in the order specified, but not necessarily contiguous.
    //
    // .. note::
    //
    //   It is recommended to set ``response_buffer_size`` based on the total Payload size for efficiency.
    //   The default buffer size is 1024 bytes when it is not set.
    repeated Payload receive = 4;

    // Specifies the size of response buffer in bytes that is used to Payload match.
    // The default value is 1024. Setting to 0 implies that the Payload will be matched against the entire response.
    google.protobuf.UInt64Value response_buffer_size = 14;

    // Specifies a list of HTTP headers that should be removed from each request that is sent to the
    // health checked cluster.
    repeated string request_headers_to_remove = 8;

    // Specifies a list of HTTP response statuses considered healthy. If provided, replaces default
    // 200-only policy - 200 must be included explicitly as needed. Ranges follow half-open
    // semantics of :ref:`Int64Range <envoy_v3_api_msg_type.v3.Int64Range>`. The start and end of each
    // range are required. Only statuses in the range [100, 600) are allowed.
    repeated Int64Range expected_statuses = 9;

    // Specifies a list of HTTP response statuses considered retriable. If provided, responses in this range
    // will count towards the configured :ref:`unhealthy_threshold <envoy_v3_api_field_config.core.v3.HealthCheck.unhealthy_threshold>`,
    // but will not result in the host being considered immediately unhealthy. Ranges follow half-open semantics of
    // :ref:`Int64Range <envoy_v3_api_msg_type.v3.Int64Range>`. The start and end of each range are required.
    // Only statuses in the range [100, 600) are allowed. The :ref:`expected_statuses <envoy_v3_api_field_config.core.v3.HealthCheck.HttpHealthCheck.expected_statuses>`
    // field takes precedence for any range overlaps with this field i.e. if status code 200 is both retriable and expected, a 200 response will
    // be considered a successful health check. By default all responses not in
    // :ref:`expected_statuses <envoy_v3_api_field_config.core.v3.HealthCheck.HttpHealthCheck.expected_statuses>` will result in
    // the host being considered immediately unhealthy i.e. if status code 200 is expected and there are no configured retriable statuses, any
    // non-200 response will result in the host being marked unhealthy.
    repeated Int64Range retriable_statuses = 12;

    // Use specified application protocol for health checks.
    CodecClientType codec_client_type = 10;
  }

  message TcpHealthCheck {
    // Empty payloads imply a connect-only health check.
    Payload send = 1;

    // When checking the response, “fuzzy” matching is performed such that each
    // payload block must be found, and in the order specified, but not
    // necessarily contiguous.
    repeated Payload receive = 2;
  }

  // `grpc.health.v1.Health
  // <https://github.com/grpc/grpc/blob/master/src/proto/grpc/health/v1/health.proto>`_-based
  // healthcheck. See `gRPC doc <https://github.com/grpc/grpc/blob/master/doc/health-checking.md>`_
  // for details.
  message GrpcHealthCheck {
    // An optional service name parameter which will be sent to gRPC service in
    // `grpc.health.v1.HealthCheckRequest
    // <https://github.com/grpc/grpc/blob/master/src/proto/grpc/health/v1/health.proto#L20>`_.
    // message. See `gRPC health-checking overview
    // <https://github.com/grpc/grpc/blob/master/doc/health-checking.md>`_ for
    // more information.
    string service_name = 1;

    // The value of the :authority header in the gRPC health check request. If
    // left empty (default value), the name of the cluster this health check is
    // associated with will be used. The authority header can be customized for
    // a specific endpoint by setting the :ref:`hostname
    // <envoy_v3_api_field_config.endpoint.v3.Endpoint.HealthCheckConfig.hostname>`
    // field.
    string authority = 2;
  }

  reserved 10;

  // The time to wait for a health check response. If the timeout is reached the
  // health check attempt will be considered a failure.
  google.protobuf.Duration timeout = 1;

  // The interval between health checks.
  google.protobuf.Duration interval = 2;

  // An optional jitter amount in milliseconds. If specified, Envoy will start health
  // checking after for a random time in ms between 0 and initial_jitter. This only
  // applies to the first health check.
  google.protobuf.Duration initial_jitter = 20;

  // An optional jitter amount in milliseconds. If specified, during every
  // interval Envoy will add interval_jitter to the wait time.
  google.protobuf.Duration interval_jitter = 3;

  // An optional jitter amount as a percentage of interval_ms. If specified,
  // during every interval Envoy will add ``interval_ms`` *
  // ``interval_jitter_percent`` / 100 to the wait time.
  //
  // If interval_jitter_ms and interval_jitter_percent are both set, both of
  // them will be used to increase the wait time.
  uint32 interval_jitter_percent = 18;

  // The number of unhealthy health checks required before a host is marked
  // unhealthy. Note that for ``http`` health checking if a host responds with a code not in
  // :ref:`expected_statuses <envoy_v3_api_field_config.core.v3.HealthCheck.HttpHealthCheck.expected_statuses>`
  // or :ref:`retriable_statuses <envoy_v3_api_field_config.core.v3.HealthCheck.HttpHealthCheck.retriable_statuses>`,
  // this threshold is ignored and the host is considered immediately unhealthy.
  google.protobuf.UInt32Value unhealthy_threshold = 4;

  // The number of healthy health checks required before a host is marked
  // healthy. Note that during startup, only a single successful health check is
  // required to mark a host healthy.
  google.protobuf.UInt32Value healthy_threshold = 5;

  // [#not-implemented-hide:] Non-serving port for health checking.
  google.protobuf.UInt32Value alt_port = 6;

  // Reuse health check connection between health checks. Default is true.
  google.protobuf.BoolValue reuse_connection = 7;

  oneof health_checker {
    // HTTP health check.
    HttpHealthCheck http_health_check = 8;

    // TCP health check.
    TcpHealthCheck tcp_health_check = 9;

    // gRPC health check.
    GrpcHealthCheck grpc_health_check = 11;
  }

  // The "no traffic interval" is a special health check interval that is used when a cluster has
  // never had traffic routed to it. This lower interval allows cluster information to be kept up to
  // date, without sending a potentially large amount of active health checking traffic for no
  // reason. Once a cluster has been used for traffic routing, Envoy will shift back to using the
  // standard health check interval that is defined. Note that this interval takes precedence over
  // any other.
  //
  // The default value for "no traffic interval" is 60 seconds.
  google.protobuf.Duration no_traffic_interval = 12;

  // The "no traffic healthy interval" is a special health check interval that
  // is used for hosts that are currently passing active health checking
  // (including new hosts) when the cluster has received no traffic.
  //
  // This is useful for when we want to send frequent health checks with
  // ``no_traffic_interval`` but then revert to lower frequency ``no_traffic_healthy_interval`` once
  // a host in the cluster is marked as healthy.
  //
  // Once a cluster has been used for traffic routing, Envoy will shift back to using the
  // standard health check interval that is defined.
  //
  // If no_traffic_healthy_interval is not set, it will default to the
  // no traffic interval and send that interval regardless of health state.
  google.protobuf.Duration no_traffic_healthy_interval = 24;

  // The "unhealthy interval" is a health check interval that is used for hosts that are marked as
  // unhealthy. As soon as the host is marked as healthy, Envoy will shift back to using the
  // standard health check interval that is defined.
  //
  // The default value for "unhealthy interval" is the same as "interval".
  google.protobuf.Duration unhealthy_interval = 14;

  // The "unhealthy edge interval" is a special health check interval that is used for the first
  // health check right after a host is marked as unhealthy. For subsequent health checks
  // Envoy will shift back to using either "unhealthy interval" if present or the standard health
  // check interval that is defined.
  //
  // The default value for "unhealthy edge interval" is the same as "unhealthy interval".
  google.protobuf.Duration unhealthy_edge_interval = 15;

  // The "healthy edge interval" is a special health check interval that is used for the first
  // health check right after a host is marked as healthy. For subsequent health checks
  // Envoy will shift back to using the standard health check interval that is defined.
  //
  // The default value for "healthy edge interval" is the same as the default interval.
  google.protobuf.Duration healthy_edge_interval = 16;

  // Specifies the path to the :ref:`health check event log <arch_overview_health_check_logging>`.
  //
  // .. attention::
  //   This field is deprecated in favor of the extension
  //   :ref:`event_logger <envoy_v3_api_field_config.core.v3.HealthCheck.event_logger>` and
  //   :ref:`event_log_path <envoy_v3_api_field_extensions.health_check.event_sinks.file.v3.HealthCheckEventFileSink.event_log_path>`
  //   in the file sink extension.
  reserved 17; // string event_log_path = 17 [deprecated = true, (envoy.annotations.deprecated_at_minor_version) = "3.0"];

  // A list of event log sinks to process the health check event.
  // [#extension-category: envoy.health_check.event_sinks]
  reserved 25; // repeated TypedExtensionConfig event_logger = 25;

  // [#not-implemented-hide:]
  // The gRPC service for the health check event service.
  // If empty, health check events won't be sent to a remote endpoint.
  reserved 22; // EventServiceConfig event_service = 22;

  // If set to true, health check failure events will always be logged. If set to false, only the
  // initial health check failure event will be logged.
  // The default value is false.
  bool always_log_health_check_failures = 19;

  // If set to true, health check success events will always be logged. If set to false, only host addition event will be logged
  // if it is the first successful health check, or if the healthy threshold is reached.
  // The default value is false.
  bool always_log_health_check_success = 26;

  // This allows overriding the cluster TLS settings, just for health check connections.
  reserved 21; // TlsOptions tls_options = 21;

  // Optional key/value pairs that will be used to match a transport socket from those specified in the cluster's
  // :ref:`tranport socket matches <envoy_v3_api_field_config.cluster.v3.Cluster.transport_socket_matches>`.
  // For example, the following match criteria
  //
  // .. code-block:: yaml
  //
  //  transport_socket_match_criteria:
  //    useMTLS: true
  //
  // Will match the following :ref:`cluster socket match <envoy_v3_api_msg_config.cluster.v3.Cluster.TransportSocketMatch>`
  //
  // .. code-block:: yaml
  //
  //  transport_socket_matches:
  //  - name: "useMTLS"
  //    match:
  //      useMTLS: true
  //    transport_socket:
  //      name: envoy.transport_sockets.tls
  //      config: { ... } # tls socket configuration
  //
  // If this field is set, then for health checks it will supersede an entry of ``envoy.transport_socket`` in the
  // :ref:`LbEndpoint.Metadata <envoy_v3_api_field_config.endpoint.v3.LbEndpoint.metadata>`.
  // This allows using different transport socket capabilities for health checking versus proxying to the
  // endpoint.
  //
  // If the key/values pairs specified do not match any
  // :ref:`transport socket matches <envoy_v3_api_field_config.cluster.v3.Cluster.transport_socket_matches>`,
  // the cluster's :ref:`transport socket <envoy_v3_api_field_config.cluster.v3.Cluster.transport_socket>`
  // will be used for health check socket configuration.
  google.protobuf.Struct transport_socket_match_criteria = 23;
}

message OutlierDetection {
  // The number of consecutive server-side error responses (for HTTP traffic,
  // 5xx responses; for TCP traffic, connection failures; for Redis, failure to
  // respond PONG; etc.) before a consecutive 5xx ejection occurs. Defaults to 5.
  google.protobuf.UInt32Value consecutive_5xx = 1;

  // The time interval between ejection analysis sweeps. This can result in
  // both new ejections as well as hosts being returned to service. Defaults
  // to 10000ms or 10s.
  google.protobuf.Duration interval = 2;

  // The base time that a host is ejected for. The real time is equal to the
  // base time multiplied by the number of times the host has been ejected and is
  // capped by :ref:`max_ejection_time<envoy_v3_api_field_config.cluster.v3.OutlierDetection.max_ejection_time>`.
  // Defaults to 30000ms or 30s.
  google.protobuf.Duration base_ejection_time = 3;

  // The maximum % of an upstream cluster that can be ejected due to outlier detection. Defaults to 10% .
  // Will eject at least one host regardless of the value if :ref:`always_eject_one_host<envoy_v3_api_field_config.cluster.v3.OutlierDetection.always_eject_one_host>` is enabled.
  google.protobuf.UInt32Value max_ejection_percent = 4;

  // The % chance that a host will be actually ejected when an outlier status
  // is detected through consecutive 5xx. This setting can be used to disable
  // ejection or to ramp it up slowly. Defaults to 100.
  google.protobuf.UInt32Value enforcing_consecutive_5xx = 5;

  // The % chance that a host will be actually ejected when an outlier status
  // is detected through success rate statistics. This setting can be used to
  // disable ejection or to ramp it up slowly. Defaults to 100.
  google.protobuf.UInt32Value enforcing_success_rate = 6;

  // The number of hosts in a cluster that must have enough request volume to
  // detect success rate outliers. If the number of hosts is less than this
  // setting, outlier detection via success rate statistics is not performed
  // for any host in the cluster. Defaults to 5.
  google.protobuf.UInt32Value success_rate_minimum_hosts = 7;

  // The minimum number of total requests that must be collected in one
  // interval (as defined by the interval duration above) to include this host
  // in success rate based outlier detection. If the volume is lower than this
  // setting, outlier detection via success rate statistics is not performed
  // for that host. Defaults to 100.
  google.protobuf.UInt32Value success_rate_request_volume = 8;

  // This factor is used to determine the ejection threshold for success rate
  // outlier ejection. The ejection threshold is the difference between the
  // mean success rate, and the product of this factor and the standard
  // deviation of the mean success rate: mean - (stdev *
  // success_rate_stdev_factor). This factor is divided by a thousand to get a
  // double. That is, if the desired factor is 1.9, the runtime value should
  // be 1900. Defaults to 1900.
  google.protobuf.UInt32Value success_rate_stdev_factor = 9;

  // The number of consecutive gateway failures (502, 503, 504 status codes)
  // before a consecutive gateway failure ejection occurs. Defaults to 5.
  google.protobuf.UInt32Value consecutive_gateway_failure = 10;

  // The % chance that a host will be actually ejected when an outlier status
  // is detected through consecutive gateway failures. This setting can be
  // used to disable ejection or to ramp it up slowly. Defaults to 0.
  google.protobuf.UInt32Value enforcing_consecutive_gateway_failure = 11;

  // Determines whether to distinguish local origin failures from external errors. If set to true
  // the following configuration parameters are taken into account:
  // :ref:`consecutive_local_origin_failure<envoy_v3_api_field_config.cluster.v3.OutlierDetection.consecutive_local_origin_failure>`,
  // :ref:`enforcing_consecutive_local_origin_failure<envoy_v3_api_field_config.cluster.v3.OutlierDetection.enforcing_consecutive_local_origin_failure>`
  // and
  // :ref:`enforcing_local_origin_success_rate<envoy_v3_api_field_config.cluster.v3.OutlierDetection.enforcing_local_origin_success_rate>`.
  // Defaults to false.
  bool split_external_local_origin_errors = 12;

  // The number of consecutive locally originated failures before ejection
  // occurs. Defaults to 5. Parameter takes effect only when
  // :ref:`split_external_local_origin_errors<envoy_v3_api_field_config.cluster.v3.OutlierDetection.split_external_local_origin_errors>`
  // is set to true.
  google.protobuf.UInt32Value consecutive_local_origin_failure = 13;

  // The % chance that a host will be actually ejected when an outlier status
  // is detected through consecutive locally originated failures. This setting can be
  // used to disable ejection or to ramp it up slowly. Defaults to 100.
  // Parameter takes effect only when
  // :ref:`split_external_local_origin_errors<envoy_v3_api_field_config.cluster.v3.OutlierDetection.split_external_local_origin_errors>`
  // is set to true.
  google.protobuf.UInt32Value enforcing_consecutive_local_origin_failure = 14;

  // The % chance that a host will be actually ejected when an outlier status
  // is detected through success rate statistics for locally originated errors.
  // This setting can be used to disable ejection or to ramp it up slowly. Defaults to 100.
  // Parameter takes effect only when
  // :ref:`split_external_local_origin_errors<envoy_v3_api_field_config.cluster.v3.OutlierDetection.split_external_local_origin_errors>`
  // is set to true.
  google.protobuf.UInt32Value enforcing_local_origin_success_rate = 15;

  // The failure percentage to use when determining failure percentage-based outlier detection. If
  // the failure percentage of a given host is greater than or equal to this value, it will be
  // ejected. Defaults to 85.
  google.protobuf.UInt32Value failure_percentage_threshold = 16;

  // The % chance that a host will be actually ejected when an outlier status is detected through
  // failure percentage statistics. This setting can be used to disable ejection or to ramp it up
  // slowly. Defaults to 0.
  //
  // [#next-major-version: setting this without setting failure_percentage_threshold should be
  // invalid in v4.]
  google.protobuf.UInt32Value enforcing_failure_percentage = 17;

  // The % chance that a host will be actually ejected when an outlier status is detected through
  // local-origin failure percentage statistics. This setting can be used to disable ejection or to
  // ramp it up slowly. Defaults to 0.
  google.protobuf.UInt32Value enforcing_failure_percentage_local_origin = 18;

  // The minimum number of hosts in a cluster in order to perform failure percentage-based ejection.
  // If the total number of hosts in the cluster is less than this value, failure percentage-based
  // ejection will not be performed. Defaults to 5.
  google.protobuf.UInt32Value failure_percentage_minimum_hosts = 19;

  // The minimum number of total requests that must be collected in one interval (as defined by the
  // interval duration above) to perform failure percentage-based ejection for this host. If the
  // volume is lower than this setting, failure percentage-based ejection will not be performed for
  // this host. Defaults to 50.
  google.protobuf.UInt32Value failure_percentage_request_volume = 20;

  // The maximum time that a host is ejected for. See :ref:`base_ejection_time<envoy_v3_api_field_config.cluster.v3.OutlierDetection.base_ejection_time>`
  // for more information. If not specified, the default value (300000ms or 300s) or
  // :ref:`base_ejection_time<envoy_v3_api_field_config.cluster.v3.OutlierDetection.base_ejection_time>` value is applied, whatever is larger.
  google.protobuf.Duration max_ejection_time = 21;

  // The maximum amount of jitter to add to the ejection time, in order to prevent
  // a 'thundering herd' effect where all proxies try to reconnect to host at the same time.
  // See :ref:`max_ejection_time_jitter<envoy_v3_api_field_config.cluster.v3.OutlierDetection.base_ejection_time>`
  // Defaults to 0s.
  google.protobuf.Duration max_ejection_time_jitter = 22;

  // If active health checking is enabled and a host is ejected by outlier detection, a successful active health check
  // unejects the host by default and considers it as healthy. Unejection also clears all the outlier detection counters.
  // To change this default behavior set this config to ``false`` where active health checking will not uneject the host.
  // Defaults to true.
  google.protobuf.BoolValue successful_active_health_check_uneject_host = 23;

  reserved 24; // repeated core.v3.TypedExtensionConfig monitors

  // If enabled, at least one host is ejected regardless of the value of :ref:`max_ejection_percent<envoy_v3_api_field_config.cluster.v3.OutlierDetection.max_ejection_percent>`.
  // Defaults to false.
  google.protobuf.BoolValue always_eject_one_host = 25;
}
