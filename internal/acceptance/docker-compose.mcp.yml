# docker-compose.mcp.yml — MCP test infrastructure overlay
# Usage: docker compose -f docker-compose.yml -f docker-compose.mcp.yml up
#
# This file is self-contained: all MCP services, volumes, and config
# overrides live here. The base docker-compose.yml has zero MCP references.

services:
  # Add MCP network alias and swap config to MCP-enabled version
  pomerium:
    volumes:
      - ./certs:/certs:ro
      - ./pomerium/config-mcp.yaml:/pomerium/config.yaml:ro
    networks:
      acceptance:
        aliases:
          - mcp.localhost.pomerium.io

  # MCP test server (SSE + Streamable HTTP transports)
  mcp-server:
    image: node:22-alpine
    working_dir: /app
    volumes:
      - ./mcp-server:/app
      - mcp-node-modules:/app/node_modules
    command: ["sh", "-c", "npm install --silent && npx tsx server.ts"]
    environment:
      PORT: "3000"
    ports:
      - "3100:3000"
    networks:
      acceptance:
        aliases:
          - mcp-server
    depends_on:
      certs-init:
        condition: service_completed_successfully
      keycloak:
        condition: service_healthy
      pomerium:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3000/health"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 15s

  # MCP Inspector (official) — React app + Node.js proxy
  mcp-inspector:
    image: node:22-alpine
    working_dir: /app
    command: ["sh", "-c", "npx -y @modelcontextprotocol/inspector@latest"]
    environment:
      NODE_TLS_REJECT_UNAUTHORIZED: "0"
      CLIENT_PORT: "6280"
      PORT: "6281"
    ports:
      - "6280:6280"
      - "6281:6281"
    networks:
      acceptance:
        aliases:
          - mcp-inspector
    depends_on:
      mcp-server:
        condition: service_healthy

  # MCPJam Inspector — alternative inspector UI
  mcpjam-inspector:
    image: node:22-alpine
    working_dir: /app
    command: ["sh", "-c", "npx -y @mcpjam/inspector@latest"]
    environment:
      NODE_TLS_REJECT_UNAUTHORIZED: "0"
    ports:
      - "6274:6274"
    networks:
      acceptance:
        aliases:
          - mcpjam-inspector
    depends_on:
      mcp-server:
        condition: service_healthy

volumes:
  mcp-node-modules:
